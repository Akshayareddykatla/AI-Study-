{% extends "base.html" %}
{% block title %}Playground - AI Smart Buddy{% endblock %}
{% block content %}
<div class="container py-4">
    <div class="row g-4">
        <!-- Editor Section -->
        <div class="col-lg-8">
            <div class="glass-card animate-up overflow-hidden border-0">
                <div
                    class="card-header bg-dark bg-opacity-75 text-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-terminal me-2 text-primary"></i>Coding Editor</h5>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm w-auto bg-glass-input text-white border-0 shadow-none"
                            id="lang-selector" name="language" form="code-form">
                            <option value="python">Python 3</option>
                            <option value="html">HTML5/CSS3</option>
                            <option value="javascript">JavaScript ES6</option>
                        </select>
                    </div>
                </div>
                <div class="p-0 border-top border-white border-opacity-10">
                    <form id="code-form" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="language" id="hidden-lang" value="python">
                        <textarea name="code" id="editor" class="form-control border-0 rounded-0" rows="18"
                            style="font-family: 'JetBrains Mono', 'Fira Code', monospace; background: #0f172a; color: #e2e8f0; resize: none; font-size: 14px; line-height: 1.6;"
                            placeholder="Start building something amazing...">print("Hello AI Study Buddy!")</textarea>
                    </form>
                </div>
                <div
                    class="card-footer bg-white bg-opacity-5 border-0 py-3 d-flex justify-content-between align-items-center">
                    <button type="button" class="btn btn-premium px-5 rounded-pill shadow-lg" id="run-btn">
                        <i class="fas fa-play me-2"></i>Execute
                    </button>
                    <div class="text-muted small">
                        <span class="badge bg-primary bg-opacity-10 text-primary border-0 me-2">Auto-save: ON</span>
                        <i class="fas fa-keyboard me-1"></i> Ctrl+Enter
                    </div>
                </div>
            </div>

            <!-- Output Section -->
            <div class="mt-4 animate-up" style="animation-delay: 100ms;">
                <div class="glass-card bg-dark border-0 overflow-hidden">
                    <div class="px-4 py-3 border-bottom border-white border-opacity-10 d-flex align-items-center">
                        <div class="d-flex gap-1 me-3">
                            <div class="rounded-circle bg-danger" style="width: 10px; height: 10px;"></div>
                            <div class="rounded-circle bg-warning" style="width: 10px; height: 10px;"></div>
                            <div class="rounded-circle bg-success" style="width: 10px; height: 10px;"></div>
                        </div>
                        <h6 class="mb-0 fw-bold text-white opacity-75 small">Output Terminal</h6>
                    </div>
                    <div class="card-body terminal-body" id="output-container"
                        style="min-height: 200px; background: #020617;">
                        <pre id="console-output" class="mb-0 text-success-emphasis font-monospace small"></pre>
                        <iframe id="html-preview" class="w-100 border-0 d-none rounded-3 bg-white"
                            style="height: 400px;"></iframe>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="glass-card p-4 mb-4 bg-primary bg-opacity-10 border-0 animate-up"
                style="animation-delay: 200ms;">
                <div class="d-flex align-items-center mb-3">
                    <div class="icon-circle bg-primary text-white me-3">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <h5 class="fw-bold mb-0 text-primary">Activity</h5>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted small fw-bold">Daily Submissions</span>
                    <span class="badge bg-primary rounded-pill px-3">{{ uses_today }}</span>
                </div>
                <div class="mt-3">
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-primary" style="width: 65%;"></div>
                    </div>
                </div>
                <p class="x-small text-muted mt-3 mb-0">Every snippet adds to your **Coding Mastery** score. Keep
                    experimenting!</p>
            </div>

            <div class="glass-card overflow-hidden animate-up" style="animation-delay: 300ms;">
                <div class="card-header bg-white bg-opacity-5 py-3 border-bottom border-light-subtle">
                    <h6 class="mb-0 fw-bold">Execution History</h6>
                </div>
                <div class="list-group list-group-flush bg-transparent">
                    {% for item in history %}
                    <div class="list-group-item bg-transparent border-light-subtle px-4 py-3 history-item">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="fw-bold text-primary small">{{ item.get_language_display }}</span>
                            <span class="text-muted x-small">{{ item.timestamp|date:"H:i" }}</span>
                        </div>
                        <code class="text-secondary x-small d-block text-truncate">{{ item.code|slice:":45" }}...</code>
                    </div>
                    {% empty %}
                    <div class="p-5 text-center text-muted">
                        <i class="fas fa-history display-6 opacity-25 mb-3"></i>
                        <p class="small mb-0">No history found</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-glass-input {
        background: rgba(255, 255, 255, 0.1) !important;
        color: white !important;
    }

    .bg-glass-input option {
        background: #1e293b;
    }

    .terminal-body {
        box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.5);
        padding: 1.5rem;
    }

    .font-monospace {
        font-family: 'JetBrains Mono', monospace !important;
    }

    .x-small {
        font-size: 0.7rem;
        font-weight: 600;
        text-uppercase: uppercase;
        letter-spacing: 0.05rem;
    }

    .history-item {
        transition: var(--transition-smooth);
    }

    .history-item:hover {
        background: rgba(67, 97, 238, 0.05) !important;
        transform: translateX(5px);
    }

    #editor:focus {
        box-shadow: none !important;
    }
</style>

<script>
    document.getElementById('run-btn').addEventListener('click', function () {
        const lang = document.getElementById('lang-selector').value;
        const code = document.getElementById('editor').value;
        const out = document.getElementById('console-output');
        const preview = document.getElementById('html-preview');

        document.getElementById('hidden-lang').value = lang;

        if (lang === 'html') {
            out.classList.add('d-none');
            preview.classList.remove('d-none');
            preview.srcdoc = code;
        } else if (lang === 'javascript') {
            preview.classList.add('d-none');
            out.classList.remove('d-none');
            out.textContent = ">>> Running JavaScript Interpreter...\n";
            try {
                const result = eval(code);
                out.textContent += "> " + (result !== undefined ? result : "Undefined (No return value)");
            } catch (e) {
                out.textContent += "!! RuntimeError: " + e.message;
            }
        } else {
            out.textContent = ">>> Sending request to AI Python Kernel...";
            document.getElementById('code-form').submit();
        }
    });

    document.getElementById('lang-selector').addEventListener('change', function () {
        const lang = this.value;
        const editor = document.getElementById('editor');
        if (lang === 'html' && editor.value === 'print("Hello AI Study Buddy!")') {
            editor.value = '<!DOCTYPE html>\n<html>\n<body>\n  <h1 style="color: #4361ee">Hello AI Buddy</h1>\n  <p>Live preview enabled!</p>\n</body>\n</html>';
        }
    });
</script>
{% endblock %}