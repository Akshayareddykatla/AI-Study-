{% extends "base.html" %}
{% block title %}Video Buddy - AI Learning Search{% endblock %}
{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-11 col-xl-10">
            <!-- Header -->
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 animate-up">
                <div>
                    <h2 class="display-6 fw-bold mb-1"><i class="fab fa-youtube text-danger me-2"></i>Video Buddy</h2>
                    <p class="text-muted mb-0">Discover the best educational content with AI-curated paths.</p>
                </div>
                <div class="mt-3 mt-md-0">
                    <a href="{% url 'video_buddy:video_favorites' %}" class="btn btn-premium rounded-pill px-4">
                        <i class="fas fa-heart me-2"></i>My Learning Vault
                    </a>
                </div>
            </div>

            <div class="row g-4">
                <!-- Chat & Search Results Area -->
                <div class="col-lg-8">
                    <div class="glass-card chat-container d-flex flex-column animate-up"
                        style="height: 700px; animation-delay: 100ms;">
                        <div id="chat-messages" class="flex-grow-1 p-4" style="overflow-y: auto;">
                            {% for item in history reversed %}
                            <!-- User Query -->
                            <div class="d-flex justify-content-end mb-4 animate-up">
                                <div class="message-user px-4 py-3 shadow-sm">
                                    <p class="mb-0 fw-medium">{{ item.query }}</p>
                                </div>
                            </div>

                            <!-- AI Discovery & Cards -->
                            <div class="mb-5 animate-up">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="icon-circle bg-danger-subtle text-danger me-3"
                                        style="width: 42px; height: 42px;">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <h6 class="fw-bold mb-0">Search Insights</h6>
                                </div>
                                 <div class="glass-card p-4 border-0 mb-3 bg-white bg-opacity-25 border-start border-danger border-4">
                                    <div class="message-content text-dark">
                                        {{ item.ai_response|linebreaks }}
                                    </div>
                                </div>

                                <div class="row g-3">
                                    {% for term_obj in item.suggested_search_terms %}
                                    <div class="col-md-6">
                                        {% with term=term_obj.query|default:term_obj %}
                                        <a href="https://www.youtube.com/results?search_query={{ term|urlencode }}"
                                            target="_blank"
                                            class="video-result-card glass-card d-flex flex-column p-3 text-decoration-none h-100">
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="play-icon bg-danger rounded-circle me-3">
                                                    <i class="fas fa-play text-white fa-xs"></i>
                                                </div>
                                                <h6 class="text-dark fw-bold mb-0 text-truncate">{{ term }}</h6>
                                            </div>
                                            <div class="ps-5">
                                                <p class="text-muted small mb-2 line-clamp-2">
                                                    {{ term_obj.explanation|default:"Click to explore this topic on YouTube." }}
                                                </p>
                                                <div class="d-flex align-items-center text-danger small fw-bold">
                                                    <span>Watch Now</span>
                                                    <i class="fas fa-external-link-alt ms-2"></i>
                                                </div>
                                            </div>
                                        </a>
                                        {% endwith %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% empty %}
                            <div
                                class="h-100 d-flex flex-column justify-content-center align-items-center text-center opacity-75">
                                <div class="icon-pulse mb-4">
                                    <i class="fab fa-youtube display-1 text-danger"></i>
                                </div>
                                <h4 class="fw-bold">Level Up with Video</h4>
                                <p class="text-muted col-md-8">Tell me what you want to learn, and I'll find the best
                                    <br>tutorials and lectures for you.
                                </p>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Search Bar -->
                        <div class="p-4 border-top border-light-subtle">
                            <form id="chat-form" method="post" class="position-relative">
                                {% csrf_token %}
                                <input type="text" name="query"
                                    class="form-control glass-input py-3 px-4 shadow-none border-0 pe-5"
                                    placeholder="e.g., 'Mastering Python Data Structures'..." required>
                                <button class="send-btn position-absolute top-50 end-0 translate-middle-y me-3"
                                    type="submit">
                                    <i class="fas fa-search"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Sidebar -->
                <div class="col-lg-4">
                    <div class="glass-card p-4 mb-4 animate-up" style="animation-delay: 200ms;">
                        <h5 class="fw-bold mb-4">Quick Favorite</h5>
                        <form id="favorite-form">
                            <div class="mb-3">
                                <label class="small fw-bold text-muted mb-2">Video Context</label>
                                <input type="text" id="fav-title" class="form-control glass-input"
                                    placeholder="What's this video about?" required>
                            </div>
                            <div class="mb-3">
                                <label class="small fw-bold text-muted mb-2">YouTube URL</label>
                                <input type="url" id="fav-url" class="form-control glass-input"
                                    placeholder="https://youtube.com/..." required>
                            </div>
                            <button type="button" onclick="addFavorite()" class="btn btn-premium w-100">Save to
                                Vault</button>
                        </form>
                    </div>

                    <div class="glass-card p-4 bg-primary bg-opacity-10 border-0 animate-up"
                        style="animation-delay: 300ms;">
                        <h6 class="fw-bold mb-3"><i class="fas fa-lightbulb text-warning me-2"></i>Pro Tip</h6>
                        <p class="small text-muted mb-0">Video learning combined with our **AI Quizzes** creates the
                            perfect memory loop. Try taking a quiz after watching a video!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .chat-container {
        border-radius: 28px !important;
        overflow: hidden;
    }

    #chat-messages::-webkit-scrollbar {
        width: 5px;
    }

    #chat-messages::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.05);
        border-radius: 10px;
    }

    .message-user {
        background: var(--primary-gradient);
        color: white;
        border-radius: 18px 18px 4px 18px;
        max-width: 80%;
    }

    .video-result-card {
        border-radius: 18px !important;
        transition: var(--transition-smooth);
        border: 1px solid rgba(0, 0, 0, 0.05) !important;
    }

    .video-result-card:hover {
        background: white !important;
        transform: scale(1.02);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
    }

    .play-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .icon-pulse {
        animation: pulse-red 2s infinite;
    }

    @keyframes pulse-red {
        0% {
            transform: scale(1);
            opacity: 0.8;
        }

        50% {
            transform: scale(1.1);
            opacity: 1;
        }

        100% {
            transform: scale(1);
            opacity: 0.8;
        }
    }

    .glass-input {
        background: rgba(0, 0, 0, 0.04) !important;
        border-radius: 15px !important;
    }

    [data-theme="dark"] .glass-input {
        background: rgba(255, 255, 255, 0.05) !important;
    }

    .send-btn {
        background: var(--primary-gradient);
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 12px;
    }
</style>

<script>
    function addFavorite() {
        const title = document.getElementById('fav-title').value;
        const url = document.getElementById('fav-url').value;
        if (!title || !url) return;

        let videoId = '';
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        if (match && match[2].length == 11) {
            videoId = match[2];
        } else {
            alert("Please enter a valid YouTube URL");
            return;
        }

        const data = {
            video_id: videoId,
            title: title,
            thumbnail_url: `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`,
            video_url: url
        };

        fetch('{% url "video_buddy:toggle_favorite" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'added') {
                    alert('Added to your Learning Vault! ðŸŒŸ');
                    document.getElementById('favorite-form').reset();
                } else {
                    alert('Removed from favorites.');
                }
            });
    }

    const chatBox = document.getElementById('chat-messages');
    chatBox.scrollTop = chatBox.scrollHeight;
</script>
{% endblock %}